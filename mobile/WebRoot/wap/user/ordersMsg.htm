##tlayout("wap/layout.htm",{head_title:"订单详情"}){

<div class="page">
    <div class="order_msg_top bg_w" style="padding-top: 1px;">
        <div class="important-message important-message-order ">
            <div class="message-status order-state-tosend">
                <div class="status-text">
                    <h3>
	                    ##if(orders.closed==1){
							已关闭
						##}else{
							##if(orders.status==0){
								待付款
							##}else if(orders.status==1){
								##if(orders.tracking==1){
									待发货
								##}else{
									待自提
								##}
							##}else if(orders.status==2){
								已发货
							##}else if(orders.status==3){
								已完成
							##}else if(orders.status==8){
								已收货
							##}
						##}
					</h3>
                </div>
            </div>
        </div>
        <ul class="step step-2 font-size-12">
        	##if(orders.closed==1){
				<li style="width: 25%;">
	                <div class="step-circle-container">
	                    <i class="step-circle"></i>
	                </div>
	                <p class="step-title font-size-12">创建订单</p>
	                <div class="step-line"></div>
	            </li>
	            <li style="width: 25%;">
	                <div class="step-circle-container">
	                    <i class="step-circle"></i>
	                </div>
	                <p class="step-title font-size-12">买家付款</p>
	                <div class="step-line"></div>
	            </li>
	            <li style="width: 25%;">
	                <div class="step-circle-container">
	                    <i class="step-circle"></i>
	                </div>
	                <p class="step-title font-size-12">商家发货</p>
	                <div class="step-line"></div>
	            </li>
	            <li style="width: 25%;">
	                <div class="step-circle-container">
	                    <i class="step-circle"></i>
	                </div>
	                <p class="step-title font-size-12">确认收货</p>
	                <div class="step-line"></div>
	            </li>
	            <li>
	                <div class="step-circle-container">
	                    <i class="step-circle"></i>
	                </div>
	                <p class="step-title font-size-12">订单完成</p>
	                <div class="step-line"></div>
	            </li>
			##}else{
				##if(orders.status==0){
					<li class="step-done cur" style="width: 25%;">
		                <div class="step-circle-container">
		                    <i class="step-circle"></i>
		                </div>
		                <p class="step-title font-size-12">创建订单</p>
		                <div class="step-line"></div>
		            </li>
				##}else{
					<li style="width: 25%;">
		                <div class="step-circle-container">
		                    <i class="step-circle"></i>
		                </div>
		                <p class="step-title font-size-12">创建订单</p>
		                <div class="step-line"></div>
		            </li>
				##}
				##if(orders.status==1){
					<li class="step-done cur" style="width: 25%;">
		                <div class="step-circle-container">
		                    <i class="step-circle"></i>
		                </div>
		                <p class="step-title font-size-12">买家付款</p>
		                <div class="step-line"></div>
		            </li>
				##}else{
					<li style="width: 25%;">
		                <div class="step-circle-container">
		                    <i class="step-circle"></i>
		                </div>
		                <p class="step-title font-size-12">买家付款</p>
		                <div class="step-line"></div>
		            </li>
				##}
				##if(orders.status==2){
					##if(orders.tracking==1){
						<li class="step-done cur" style="width: 25%;">
			                <div class="step-circle-container">
			                    <i class="step-circle"></i>
			                </div>
			                <p class="step-title font-size-12">商家发货</p>
			                <div class="step-line"></div>
			            </li>
					##}else{
						<li class="step-done cur" style="width: 25%;">
			                <div class="step-circle-container">
			                    <i class="step-circle"></i>
			                </div>
			                <p class="step-title font-size-12">买家自提</p>
			                <div class="step-line"></div>
			            </li>
					##}
				##}else{
					##if(orders.tracking==1){
						<li style="width: 25%;">
			                <div class="step-circle-container">
			                    <i class="step-circle"></i>
			                </div>
			                <p class="step-title font-size-12">商家发货</p>
			                <div class="step-line"></div>
			            </li>
			    	##}else{
			    		<li style="width: 25%;">
			                <div class="step-circle-container">
			                    <i class="step-circle"></i>
			                </div>
			                <p class="step-title font-size-12">买家自提</p>
			                <div class="step-line"></div>
			            </li>
			    	##}
				##}
				##if(orders.status==8){
					<li class="step-done cur" style="width: 25%;">
		                <div class="step-circle-container">
		                    <i class="step-circle"></i>
		                </div>
		                <p class="step-title font-size-12">确认收货</p>
		                <div class="step-line"></div>
		            </li>
				##}else{
					<li style="width: 25%;">
		                <div class="step-circle-container">
		                    <i class="step-circle"></i>
		                </div>
		                <p class="step-title font-size-12">确认收货</p>
		                <div class="step-line"></div>
		            </li>
				##}
				##if(orders.status==3){
					<li class="step-done cur">
		                <div class="step-circle-container">
		                    <i class="step-circle"></i>
		                </div>
		                <p class="step-title font-size-12">订单完成</p>
		                <div class="step-line"></div>
		            </li>
				##}else{
					<li>
		                <div class="step-circle-container">
		                    <i class="step-circle"></i>
		                </div>
		                <p class="step-title font-size-12">订单完成</p>
		                <div class="step-line"></div>
		            </li>
				##}
			##}
        </ul>
        ##if(orders.tracking==1){
        	<div class="app-order express" style="font-weight: normal;font-size: 14px;">
				<div style="margin-top: 10px;margin-left: 10px;margin-bottom: 10px;">收件人：${orders.take_name!} | ${orders.take_telephone!}</div>
				<div style="font-size: 12px;margin-bottom: 10px;margin-left: 10px;">${orders.take_area_msg!}${orders.take_address!}（${orders.take_post_code!}）</div>
	        </div>
        ##}else{
        	<div class="app-order express" style="font-weight: normal;font-size: 14px;">
				<div style="margin-top: 10px;margin-left: 10px;margin-bottom: 10px;">自提人：${orders.take_name!} | ${orders.take_telephone!}</div>
	        </div>
        ##}
    </div>
    <div class="shop_info">
		<div class="left">
			<div class="title">${shop.title!}</div>
			<div class="address">${shop.address!}</div>
		</div>
		<div class="right">
			<a href="tel:${shop.mobile!}" class="right_func_item">
				<img src="/wap/images/tel.png" />
			</a>
		</div>
	</div>
    <div class="js-goods-list-container">
        <div class="js-header header">
            <a class="font-size-14" href="javascript:void(0)">商品详情</a>
        </div>
        <div class="js-goods-list">
            ##for(_item in goods_list!){
				<div class="js-goods-item order-goods-item clearfix block-list">
					<div class="name-card name-card-goods clearfix">
						##if(_item.diy_id!=null && _item.diy_id!=""){
                       		<a href="/wap/goods?code=${_item.goods_code!}&dcode=${_item.diy_code!}" class="thumb"><img class="js-view-image" src="${_item.goods_img_url!}" /></a>
                       	##}else{
                       		<a href="/wap/goods?code=${_item.goods_code!}" class="thumb"><img class="js-view-image" src="${_item.goods_img_url!}" /></a>
                       	##}
					    <div class="detail">
					    	<div class="clearfix detail-row">
					            <div class="right-col text-right">
					                <div class="price">¥<span>${_item.item_price!}</span></div>
					            </div>
					            <div class="left-col">
					            	<a href="/wap/goods?code=${_item.goods_code!}">
					                    ##if(_item.diy_id!=null && _item.diy_id!=""){
			                        		<a href="/wap/goods?code=${_item.goods_code!}&dcode=${_item.diy_code!}"><h3 class="l2-ellipsis">${_item.goods_title!}</h3></a>
			                        	##}else{
			                        		<a href="/wap/goods?code=${_item.goods_code!}"><h3 class="l2-ellipsis">${_item.goods_title!}</h3></a>
			                        	##}
					                </a>
					            </div>
					        </div>
					        <div class="clearfix detail-row">
					            <div class="right-col">
					                <div class="num c-gray-darker">* ${_item.item_number!}</div>
					            </div>
					            <div class="left-col format_title">
					           		<p class="l2-ellipsis c-gray-darker sku">
					           			【${_item.goods_format_title!}】
					           			##if(_item.diy_id!=null && _item.diy_id!=""){
                                    		【定制商品】
                                    	##}
                                    	##if(_item.goods_source==1 || _item.goods_source==2){
                                    		【${_item.parent.title!}->${_item.brand.title!}】
                                    	##}
					           		</p>
					            </div>
					        </div>
					    </div>
					</div>
					<div class="orderMsg_func">
						##if(orders.closed==0 && orders.status!=0 && _item.goods_number!=0){
				           	<a href="/wap/user/picture?oiid=${_item.id!}" class="orderMsg_func_item cur">上传打印照片</a>
			            ##}
			             ##if(_item.comment==1){
				        	<a href="/wap/user/comment?gid=${_item.goods_id!}&code=${orders.code!}" class="orderMsg_func_item">添加评价</a>
				        ##}
					</div>
				</div>
			##}
        </div>
    </div>
    ##if(orders.tracking_code!=null && orders.tracking_code!=""){
	    <div class="weui-cells order_msg">
	        <div class="weui-cell">
	            <div class="weui-cell__bd">
	                <p>运单号</p>
	            </div>
	            <div class="weui-cell__ft"><a href="/wap/user/tracking?code=${orders.code!}">${orders.tracking_company!}（${orders.tracking_code!}）</a></div>
	        </div>
	    </div>
    ##}
    <div class="weui-cells order_msg">
        <div class="weui-cell">
            <div class="weui-cell__bd">
                <p>商品小计</p>
            </div>
            <div class="weui-cell__ft">￥${orders.subtotal!}</div>
        </div>
        <div class="weui-cell">
            <div class="weui-cell__bd">
                <p>运费</p>
            </div>
            <div class="weui-cell__ft">￥${orders.freight_price!}</div>
        </div>
        <div class="weui-cell">
            <div class="weui-cell__bd">
                <p>总计</p>
            </div>
            <div class="weui-cell__ft">￥${orders.grand_total!}</div>
        </div>
        ##if(orders.payment!=null && orders.payment!=""){
        	##if(orders.payment==1){
        		<div class="weui-cell">
		            <div class="weui-cell__bd">
		                <p>支付方式</p>
		            </div>
		            <div class="weui-cell__ft">微信支付</div>
		        </div>
        	##}else{
        		<div class="weui-cell">
		            <div class="weui-cell__bd">
		                <p>支付方式</p>
		            </div>
		            <div class="weui-cell__ft">线下支付</div>
		        </div>
        	##}
        ##}
        ##if(orders.tracking==1){
       		<div class="weui-cell">
	            <div class="weui-cell__bd">
	                <p>发货方式</p>
	            </div>
	            <div class="weui-cell__ft">邮寄</div>
	        </div>
       	##}else{
       		<div class="weui-cell">
	            <div class="weui-cell__bd">
	                <p>发货方式</p>
	            </div>
	            <div class="weui-cell__ft">自提</div>
	        </div>
       	##}
    </div>
    <div class="weui-cells order_msg">
        <div class="weui-cell">
            <div class="weui-cell__bd">
                <p>订单号</p>
            </div>
            <div class="weui-cell__ft">${orders.code!}</div>
        </div>
        <div class="weui-cell">
            <div class="weui-cell__bd">
                <p>创建时间</p>
            </div>
            <div class="weui-cell__ft">${orders.create_date!,dateFormat='yyyy-MM-dd HH:mm'}</div>
        </div>
        ##if(orders.payment_date!=null && orders.payment_date!=""){
        	<div class="weui-cell">
	            <div class="weui-cell__bd">
	                <p>付款时间</p>
	            </div>
	            <div class="weui-cell__ft">${orders.payment_date!,dateFormat='yyyy-MM-dd HH:mm'}</div>
	        </div>
        ##}
        ##if(orders.tracking_date!=null && orders.tracking_date!=""){
        	<div class="weui-cell">
	            <div class="weui-cell__bd">
	                <p>发货时间</p>
	            </div>
	            <div class="weui-cell__ft">${orders.tracking_date!,dateFormat='yyyy-MM-dd HH:mm'}</div>
	        </div>
        ##}
        ##if(orders.received_date!=null && orders.received_date!=""){
        	<div class="weui-cell">
	            <div class="weui-cell__bd">
	                <p>收货时间</p>
	            </div>
	            <div class="weui-cell__ft">${orders.received_date!,dateFormat='yyyy-MM-dd HH:mm'}</div>
	        </div>
        ##}
        ##if(orders.finished_date!=null && orders.finished_date!=""){
        	<div class="weui-cell">
	            <div class="weui-cell__bd">
	                <p>完成时间</p>
	            </div>
	            <div class="weui-cell__ft">${orders.finished_date!,dateFormat='yyyy-MM-dd HH:mm'}</div>
	        </div>
        ##}
    </div>
</div>
<div style="height: 50px;"></div>
<div class="cart-bottom order_buttom">
    <div class="left">
        <div class="one">总计：￥${orders.grand_total!}</div>
    </div>
    <div class="right">
    	##if(orders.closed==1){
			<!-- 已关闭 -->
            <a href="javascript:deleteOrders()" class="bottom-button bottom-button-active" style="background: #bbb;">删除订单</a>
		##}else{
			##if(orders.status==0){
				<!-- 待付款 -->
				<a href="javascript:colseOrders()" class="bottom-button bottom-button-active" style="background: #bbb;display: inline-block;">关闭订单</a>
				##if(shop.payment==1){
		    		<a href="javascript:paymentOrders()" class="bottom-button bottom-button-active" style="display: inline-block;margin-left: 0px;">微信支付</a>
		    	##}else if(shop.payment==2){
		    	##}else{
			        <a href="javascript:paymentOrders()" class="bottom-button bottom-button-active" style="display: inline-block;margin-left: 0px;">微信支付</a>
		    	##}
			##}else if(orders.status==1){
				<!-- 待发货 -->
			##}else if(orders.status==2){
				<!-- 已发货 -->
				<a href="javascript:reciveTracking()" class="bottom-button bottom-button-active">确认收货</a>
			##}else if(orders.status==3){
				<!-- 已完成 -->
			##}else if(orders.status==8){
				<!-- 已收货 -->
			##}
		##}
    </div>
</div>
<script>
function colseOrders(){
	
	if(confirm("确定要关闭订单吗？")){
		$.post("/wap/user/colseOrders",{code:'${orders.code}'},function(data){
			if(data.success){
				location.reload(true);
			}else{
				alert(data.msg);
			}
		})
	}
}
function deleteOrders(){
	
	if(confirm("确定要删除订单吗？")){
		$.post("/wap/user/deleteOrders",{code:'${orders.code}'},function(data){
			if(data.success){
				window.location.href="/wap/user/orders";
			}else{
				alert(data.msg);
			}
		})
	}
}
function reciveTracking(){
	
	if(confirm("确定要确认收货吗？")){
		$.post("/wap/user/reciveTracking",{code:'${orders.code}'},function(data){
			if(data.success){
				location.reload(true);
			}else{
				alert(data.msg);
			}
		})
	}
}
var new_post=1;
function paymentOrders(){
	
	if(new_post==1){
		new_post=0;
		$.post("/wap/shop/payment",{code:'${orders.code}'},function(data){
			if(data.success){
				WeixinJSBridge.invoke('getBrandWCPayRequest',{
					"appId":data.pay_msg.appId,
					"timeStamp":data.pay_msg.timeStamp,
					"nonceStr":data.pay_msg.nonceStr,
					"package":data.pay_msg._package,
					"signType": "MD5",
					"paySign":data.pay_msg.paySign
				},
				function(res){
					new_post=1;
					if(res.err_msg=='get_brand_wcpay_request:ok'){
						alert("支付成功");
						setTimeout(function(){
							location.reload(true);
						}, 1000);
					}else{
						alert("支付失败");
						setTimeout(function(){
							location.reload(true);
						}, 1000);
					}
				});
			}else{
				new_post=1;
				alert(data.msg);
				setTimeout(function(){
					location.reload(true);
				}, 1000);
			}
		});	 
	}else{
		alert("支付请求中...");
	}
}
</script>
##}
